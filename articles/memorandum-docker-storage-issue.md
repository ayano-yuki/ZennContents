---
title: "Dockerで呑気に開発していたら、パソコンの容量が爆速でないなった場合の対処法"
emoji: "📓"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Docker, windows]
published: false
---
# はじめに
Dockerで呑気に開発していたら、いつの間にか100GBも占領されていたアヤノです。

Dockerは、ローカル環境を汚さず、どこでも・いつでも同じ開発環境を再現できる、とても便利なツールです。しかし、**その内部でどんなデータがどのように保存されているか**を正しく理解していないと、パソコンの容量がじわじわと圧迫され、気づいたときには「Cドライブが真っ赤！」なんてことになります。特にWindowsユーザーの場合、DockerはWSLを通して動作しているケースが多く、容量を開放するのがちょっと面倒です。

この記事では、「なぜDockerが容量を圧迫するのか？どう対処すればいいのか？」を解説していきます。

# TL;DR

# なぜDockerでストレージが死ぬのか？
Dockerは開発環境を簡単に構築できますが、実は内部で大量のデータを保存しています。  
主な保存先は以下の3つです。

| 項目          | 内容の説明                               |
|---------------|----------------------------------------|
| **Dockerイメージ** | - コンテナの元となるファイル群　| 
| **コンテナ**       | - 実際に動いている、あるいは停止中のアプリケーションの実態　| 
| **ボリューム**     | データベースなどの永続データを保存　|


Windows環境でDockerを動かす場合、これらはWSL2の仮想ディスク（`.vhdx`ファイル）内に格納されています。この仮想ディスクは、一度大きくなると自動で縮小されないため、容量が圧迫されやすいのが特徴です。次のセクションでは、これらのデータを掃除するコマンドについて解説します。

# docker system pruneで仮想ディスクをきれいにする
Dockerのストレージを整理するときに使われるのは`docker system prune`です。これは、使われていないコンテナ、ネットワーク、イメージ、キャッシュなどを一括で削除してくれる便利なコマンドです。このコマンドを実行すると、不要なデータが一掃され、ストレージの空き容量が増えることが期待されます。

```sh
docker system prune -a --volumes

# - `-a` オプションは、使用されていないすべてのイメージも削除対象に含めます。  
# - `--volumes` を付けることで、使われていないボリュームもまとめて削除します。
```

また、このコマンドを使わなくてもDocker Desktopで同様な操作ができます。Docker Desktopですることにより、どのデータがどれくらい容量を使っているかを視覚的に確認しながら削除でき、コマンド操作に不慣れな方も安心して操作できます。

1. Docker Desktopを開く  
2. 左メニューの「Resources」→「Disk」へ移動  
3. 「Clean / Purge data」や「Prune system」などのボタンがあり、ここから不要なイメージやコンテナ、ボリュームを選択して削除できます

しかし、**これらの操作はあくまでもDocker内の不要データを削除するもので、Windows側のWSL2の仮想ディスクファイルのサイズ自体を小さくするわけではありません**。そのため、いくら`docker system prune`をしても、Windowsのドライブ容量が劇的に増えないケースがあります。

# 上記の対処法でも容量が戻らない理由

前のセクションで紹介した操作は、Docker内部の不要データを削除するには有効ですが、それでもWindowsのディスク容量が大幅に回復しないケースがよくあります。これは、DockerがWindows上でWSL2という仮想環境内で動作しているためです。  

DockerのLinux環境のファイルは、WSL2の仮想ディスクファイル（`ext4.vhdx`）の中に保存されています。この仮想ディレクトリファイルの特徴は以下のようになっております。

- `ext4.vhdx` ファイルは一つの大きな仮想ディスクで、Linuxファイルシステム全体を格納しています。  
- ファイルを削除しても、WindowsのホストOS側から見るとこの仮想ディスクファイルのサイズはすぐには縮みません。  
- 一度膨らんだ仮想ディスクのサイズは、自動で縮小されない仕様になっているためです。

そのため、**Dockerの中で不要なファイルを削除しても、WSL2仮想ディスクファイル自体の容量は減らず、結果としてWindowsのドライブ容量に反映されない**のです。

この問題を放置しておくと、Dockerを使い続ける限り仮想ディスクのサイズがどんどん大きくなっていきます。そして、普通のファイル削除の感覚で `docker system prune` を繰り返しても、WSL2仮想ディスクのファイルサイズは減らず、気づいたときには100GBもDockerに占領されます。


# 本当の解決策：WSL2仮想ディスクの手動最適化

# その他の対策と予防法

# おわりに